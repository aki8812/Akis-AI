<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文作業小幫手</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 網站圖示 (瀏覽器分頁) -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA 相關 meta -->
    <meta name="theme-color" content="#f0f9ff">
    <!-- 更新：iOS 圖示指向 192px 的 PNG -->
    <link rel="apple-touch-icon" href="icon/icon-192x192.png"> 

    <!-- 設定字體，優先使用 Inter，並包含你偏好的「微軟正黑體」 -->
    <style>
      body {
        /* 使用者偏好顏色：天空淡藍作為背景 */
        font-family: 'Inter', '微軟正黑體', 'Microsoft JhengHei', sans-serif;
        background-color: #f0f9ff; /* Tailwind's blue-50，接近天空淡藍 */
      }
      /* 保持結果區域的換行格式 */
      .gemini-result {
        white-space: pre-wrap;
        word-break: break-word;
      }
      /* 隱藏 input[type=file] 的預設樣式 */
      .file-input {
        width: 0.1px;
        height: 0.1px;
        opacity: 0;
        overflow: hidden;
        position: absolute;
        z-index: -1;
      }
      .file-input + label {
        cursor: pointer;
        display: inline-block;
      }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- 主應用程式容器 -->
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 overflow-hidden transition-all duration-300">

        <!-- 
          頁面 1: 首頁 (HomePage)
        -->
        <div id="homePage">
            <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">英文作業小幫手</h1>
            <p class="text-center text-gray-600 mb-8">請選擇你需要協助的項目：</p>
            <div class="space-y-4">
                <!-- 使用者偏好顏色：檸檬黃作為按鈕背景 -->
                <button onclick="showPage('translationPage')" class="w-full bg-yellow-300 text-black font-bold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-400 transition-colors duration-200">
                    中翻英 練習
                </button>
                <button onclick="showPage('mcqPage')" class="w-full bg-yellow-300 text-black font-bold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-400 transition-colors duration-200">
                    選擇題 / 閱讀測驗
                </button>
            </div>
            <p class="text-xs text-center text-gray-400 mt-8">由 Gemini 2.5 驅動</p>
        </div>

        <!-- 
          頁面 2: 翻譯 (TranslationPage)
          預設隱藏 (hidden)
        -->
        <div id="translationPage" class="hidden">
            <button onclick="showPage('homePage')" class="text-blue-600 hover:text-blue-800 mb-4">&larr; 返回首頁</button>
            <h2 class="text-2xl font-bold text-blue-800 mb-4">中翻英 練習</h2>
            
            <!-- 文字輸入 -->
            <textarea id="translationText" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="請在這裡輸入要翻譯的中文句子..."></textarea>
            
            <p class="text-center text-gray-500 my-2">或</p>

            <!-- 圖片/相機輸入 -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input type="file" accept="image/*" id="translationFileInput" class="file-input" onchange="handleFileInput(event, 'translation')">
                <label for="translationFileInput" class="w-full bg-blue-500 text-white text-center font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                    上傳圖片
                </label>
                <button onclick="openCamera('translation')" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                    開啟相機
                </button>
            </div>

            <!-- 圖片預覽 -->
            <div id="translationPreview" class="hidden min-h-[100px] border-2 border-dashed border-gray-300 rounded-lg p-4 flex justify-center items-center mb-4">
                <img id="translationImgPreview" src="" alt="圖片預覽" class="max-w-full max-h-48 rounded-md">
            </div>

            <!-- 提交按鈕 -->
            <button id="translateButton" onclick="handleTranslation()" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition-colors">
                開始翻譯
            </button>

            <!-- 結果顯示區域 -->
            <div id="translationLoader" class="hidden text-center my-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2 text-gray-600">Gemini 正在思考中...</p>
            </div>
            <div id="translationError" class="hidden text-red-500 my-4"></div>
            <div id="translationResult" class="mt-4 p-4 bg-gray-50 rounded-lg gemini-result"></div>
        </div>

        <!-- 
          頁面 3: 選擇題 (MCQPage)
          預設隱藏 (hidden)
        -->
        <div id="mcqPage" class="hidden">
            <button onclick="showPage('homePage')" class="text-blue-600 hover:text-blue-800 mb-4">&larr; 返回首頁</button>
            <h2 class="text-2xl font-bold text-blue-800 mb-4">選擇題 / 閱讀測驗</h2>
            
            <p class="text-gray-700 mb-4">請上傳作業圖片（可上傳多張）或使用相機拍攝。</p>

            <!-- 圖片/相機輸入 -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input type="file" accept="image/*" id="mcqFileInput" class="file-input" multiple onchange="handleFileInput(event, 'mcq')">
                <label for="mcqFileInput" class="w-full bg-blue-500 text-white text-center font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                    上傳圖片 (多選)
                </label>
                <button onclick="openCamera('mcq')" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                    開啟相機
                </button>
            </div>

            <!-- 圖片預覽 (多張) -->
            <div id="mcqPreview" class="hidden min-h-[100px] border-2 border-dashed border-gray-300 rounded-lg p-4 flex flex-wrap gap-2 mb-4">
                <!-- 圖片縮圖會加到這裡 -->
            </div>
            
            <!-- 提交按鈕 -->
            <button id="mcqButton" onclick="handleMCQ()" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-600 transition-colors">
                分析答案
            </button>

            <!-- 結果顯示區域 -->
            <div id="mcqLoader" class="hidden text-center my-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2 text-gray-600">Gemini 正在分析題目...</p>
            </div>
            <div id="mcqError" class="hidden text-red-500 my-4"></div>
            <div id="mcqResult" class="mt-4 p-4 bg-gray-50 rounded-lg gemini-result"></div>
        </div>
    </div>

    <!-- 
      相機 Modal (彈出視窗)
      預設隱藏 (hidden)
    -->
    <div id="cameraModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-50 p-4">
        <video id="cameraVideo" playsinline autoplay class="w-full max-w-lg rounded-lg mb-4"></video>
        <div class="flex space-x-4">
            <button id="captureButton" class="bg-yellow-300 text-black font-bold py-3 px-6 rounded-full shadow-lg text-lg">拍攝</button>
            <button onclick="closeCamera()" class="bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-full shadow-lg">關閉</button>
        </div>
    </div>
    <!-- 用於繪製畫面的隱藏 canvas -->
    <canvas id="cameraCanvas" class="hidden"></canvas>


    <!-- 
      JavaScript 邏輯
    -->
    <script>

        const API_KEY = "AIzaSyApDCdccFbZv-HqISVjTryU9e1ufnbJ8Cs";
        
        // 我們使用 gemini-2.5-flash-preview-09-2025 模型，因為它支援圖片輸入 (vision)
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

        // -----------------------------------------------------------------
        // 狀態變數 (State)
        // -----------------------------------------------------------------
        let currentPage = 'homePage';
        let translationImageBase64 = null; // 儲存翻譯用的單張 base64 圖片
        let mcqImagesBase64 = [];         // 儲存選擇題用的多張 base64 圖片
        let cameraStream = null;          // 儲存相機串流
        let cameraTarget = null;          // 儲存相機的目標 ('translation' 或 'mcq')

        // -----------------------------------------------------------------
        // DOM 元素參考
        // -----------------------------------------------------------------
        const pages = {
            homePage: document.getElementById('homePage'),
            translationPage: document.getElementById('translationPage'),
            mcqPage: document.getElementById('mcqPage')
        };

        const cameraModal = document.getElementById('cameraModal');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const captureButton = document.getElementById('captureButton');

        const translation = {
            text: document.getElementById('translationText'),
            preview: document.getElementById('translationPreview'),
            imgPreview: document.getElementById('translationImgPreview'),
            loader: document.getElementById('translationLoader'),
            error: document.getElementById('translationError'),
            result: document.getElementById('translationResult'),
            button: document.getElementById('translateButton')
        };

        const mcq = {
            preview: document.getElementById('mcqPreview'),
            loader: document.getElementById('mcqLoader'),
            error: document.getElementById('mcqError'),
            result: document.getElementById('mcqResult'),
            button: document.getElementById('mcqButton')
        };
        
        // -----------------------------------------------------------------
        // 頁面導航 (Navigation)
        // -----------------------------------------------------------------
        
        /**
         * 顯示指定的頁面，並隱藏其他頁面
         * @param {string} pageId - 要顯示的頁面 ID ('homePage', 'translationPage', 'mcqPage')
         */
        function showPage(pageId) {
            // 清理上一頁的狀態
            if (currentPage === 'translationPage') {
                translationImageBase64 = null;
                translation.text.value = '';
                translation.preview.classList.add('hidden');
                translation.result.innerHTML = '';
                translation.error.innerHTML = '';
            } else if (currentPage === 'mcqPage') {
                mcqImagesBase64 = [];
                mcq.preview.classList.add('hidden');
                mcq.preview.innerHTML = '';
                mcq.result.innerHTML = '';
                mcq.error.innerHTML = '';
            }

            currentPage = pageId;
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            if (pages[pageId]) {
                pages[pageId].classList.remove('hidden');
            }
        }

        // -----------------------------------------------------------------
        // 圖片與相機處理 (Image & Camera Handling)
        // -----------------------------------------------------------------

        /**
         * 處理檔案上傳
         * @param {Event} event - 檔案輸入事件
         * @param {string} target - 'translation' 或 'mcq'
         */
        function handleFileInput(event, target) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            if (target === 'translation') {
                // 翻譯只接受一張
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    translationImageBase64 = e.target.result;
                    updateImagePreview('translation', translationImageBase64);
                };
                reader.readAsDataURL(file);
            } else if (target === 'mcq') {
                // 選擇題可接受多張
                mcqImagesBase64 = []; // 重新上傳時清空
                mcq.preview.innerHTML = ''; // 清空預覽
                
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Data = e.target.result;
                        mcqImagesBase64.push(base64Data);
                        updateImagePreview('mcq', base64Data, true);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        /**
         * 更新圖片預覽區域
         * @param {string} target - 'translation' 或 'mcq'
         * @param {string} base64Data - 圖片的 base64 資料
         * @param {boolean} multiple - 是否為多圖模式 (用於 mcq)
         */
        function updateImagePreview(target, base64Data, multiple = false) {
            if (target === 'translation') {
                translation.imgPreview.src = base64Data;
                translation.preview.classList.remove('hidden');
            } else if (target === 'mcq') {
                const img = document.createElement('img');
                img.src = base64Data;
                img.className = 'w-20 h-20 object-cover rounded-md border border-gray-300';
                mcq.preview.appendChild(img);
                mcq.preview.classList.remove('hidden');
            }
        }

        /**
         * 開啟相機
         * @param {string} target - 'translation' 或 'mcq'
         */
        async function openCamera(target) {
            cameraTarget = target;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("您的瀏覽器不支援相機功能。");
                return;
            }
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // 優先使用後置鏡頭
                });
                cameraVideo.srcObject = cameraStream;
                cameraModal.classList.remove('hidden');
            } catch (err) {
                console.error("無法開啟相機:", err);
                alert("無法開啟相機。請確認您已授權。");
            }
        }

        /**
         * 關閉相機
         */
        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            cameraModal.classList.add('hidden');
            cameraVideo.srcObject = null;
        }

        /**
         * 拍攝照片
         */
        captureButton.onclick = () => {
            cameraCanvas.width = cameraVideo.videoWidth;
            cameraCanvas.height = cameraVideo.videoHeight;
            const context = cameraCanvas.getContext('2d');
            context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
            
            // 將畫布內容轉為 base64 (jpeg 格式以節省大小)
            const base64Data = cameraCanvas.toDataURL('image/jpeg');

            if (cameraTarget === 'translation') {
                translationImageBase64 = base64Data;
                updateImagePreview('translation', base64Data);
                closeCamera(); // 翻譯拍完一張就關閉
            } else if (cameraTarget === 'mcq') {
                mcqImagesBase64.push(base64Data);
                updateImagePreview('mcq', base64Data, true);
                // 選擇題模式不自動關閉，讓使用者可以拍多張
                // 可以在此加一個提示，例如 "已拍攝第 N 張"
            }
        };

        // -----------------------------------------------------------------
        // Gemini API 呼叫
        // -----------------------------------------------------------------

        /**
         * 顯示載入中、錯誤或結果
         * @param {object} ui - ui 元素物件 (e.g., translation 或 mcq)
         * @param {string} state - 'loading', 'error', 'success'
         * @param {string} content - 要顯示的內容 (錯誤訊息或成功結果)
         */
        function showResultState(ui, state, content = '') {
            ui.loader.classList.add('hidden');
            ui.error.classList.add('hidden');
            ui.result.classList.add('hidden');
            ui.button.disabled = false;

            if (state === 'loading') {
                ui.loader.classList.remove('hidden');
                ui.error.innerHTML = '';
                ui.result.innerHTML = '';
                ui.button.disabled = true;
            } else if (state === 'error') {
                ui.error.innerHTML = content;
                ui.error.classList.remove('hidden');
            } else if (state === 'success') {
                ui.result.innerHTML = content;
                ui.result.classList.remove('hidden');
            }
        }

        /**
         * 處理翻譯請求
         */
        async function handleTranslation() {
            const textInput = translation.text.value.trim();
            
            if (!textInput && !translationImageBase64) {
                showResultState(translation, 'error', '請輸入文字或上傳/拍攝一張圖片。');
                return;
            }
            if (API_KEY === "YOUR_GOOGLE_AI_STUDIO_API_KEY") {
                showResultState(translation, 'error', '請在 JavaScript 中設定您的 Google AI Studio API 金鑰。');
                return;
            }

            showResultState(translation, 'loading');

            // 建立 Prompt
            let prompt = "";
            if (textInput && !translationImageBase64) {
                prompt = `請將以下中文句子翻譯為通順的英文：\n"${textInput}"\n\n請提供3種不同的、語氣中性且常用（非過度正式或口語）的翻譯版本。請用數字列表格式回覆。`;
            } else if (translationImageBase64) {
                prompt = `這是一張包含中文句子的圖片。請翻譯圖片中的中文句子為通順的英文。如果圖片中有多個句子，請翻譯主要的句子，或是最多兩句。\n\n請提供3種不同的、語氣中性且常用（非過度正式或口D）的翻譯版本。請用數字列表格式回覆。`;
            }

            // 準備圖片資料
            const images = translationImageBase64 ? [translationImageBase64] : [];

            try {
                const resultText = await callGeminiAPI(prompt, images);
                showResultState(translation, 'success', resultText);
            } catch (error) {
                console.error(error);
                showResultState(translation, 'error', `翻譯失敗：${error.message}`);
            }
        }

        /**
         * 處理選擇題請求
         */
        async function handleMCQ() {
            if (mcqImagesBase64.length === 0) {
                showResultState(mcq, 'error', '請至少上傳或拍攝一張作業圖片。');
                return;
            }
            if (API_KEY === "YOUR_GOOGLE_AI_STUDIO_API_KEY") {
                showResultState(mcq, 'error', '請在 JavaScript 中設定您的 Google AI Studio API 金鑰。');
                return;
            }

            showResultState(mcq, 'loading');

            // 建立 Prompt
            const prompt = "這是一份或多份英文作業圖片，內容包含選擇題和/或閱讀測驗。請仔細分析圖片中的所有問題，並提供每個問題的正確答案。\n\n請依照以下格式回覆：\n1. (答案)\n2. (答案)\n...\n如果題目有A, B, C, D選項，請直接提供選項（例如：B）。如果沒有選項，請提供簡短的答案。";

            try {
                const resultText = await callGeminiAPI(prompt, mcqImagesBase64);
                showResultState(mcq, 'success', resultText);
            } catch (error) {
                console.error(error);
                showResultState(mcq, 'error', `分析失敗：${error.message}`);
            }
        }

        /**
         * 核心 API 呼叫函式 (包含指數退避重試)
         * @param {string} prompt - 文字提示
         * @param {string[]} base64Images - Base64 圖片字串陣列 (含 data: prefix)
         * @param {number} retries - 重試次數
         * @returns {Promise<string>} - Gemini 回應的文字
         */
        async function callGeminiAPI(prompt, base64Images = [], retries = 3) {
            // 1. 建立 API payload
            const parts = [];
            
            // 加入文字
            parts.push({ text: prompt });

            // 加入圖片 (並移除 base64 prefix)
            base64Images.forEach(base64String => {
                const cleanBase64 = base64String.split(',')[1];
                const mimeType = base64String.match(/data:(image\/[a-z]+);/)[1] || 'image/jpeg';
                parts.push({
                    inlineData: {
                        mimeType: mimeType,
                        data: cleanBase64
                    }
                });
            });

            const payload = {
                contents: [{ parts: parts }]
                // 可以加上 generationConfig (例如溫度) 或 safetySettings
            };

            // 2. 執行 Fetch (含重試機制)
            let attempt = 0;
            while (attempt < retries) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API 錯誤 (HTTP ${response.status}): ${errorBody.error?.message || response.statusText}`);
                    }

                    const result = await response.json();
                    
                    // 檢查是否有候選答案
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        
                        // 檢查是否有安全阻擋
                        if (result.candidates[0].finishReason === 'SAFETY') {
                             throw new Error("回應因為安全設定而被阻擋。");
                        }
                        
                        const text = result.candidates[0].content.parts[0].text;
                        return text; // 成功，回傳文字
                    
                    } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                        // 檢查是否有提示阻擋
                        throw new Error(`提示因為 ${result.promptFeedback.blockReason} 而被阻擋。`);
                    
                    } else {
                        throw new Error("API 回應格式無效或沒有內容。");
                    }
                
                } catch (error) {
                    console.error(`API C呼叫失敗 (第 ${attempt + 1} 次):`, error);
                    attempt++;
                    if (attempt >= retries) {
                        // 最後一次重試失敗，拋出錯誤
                        throw error;
                    }
                    // 指數退避 (Exponential Backoff)
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

    </script>
    
    <!-- PWA Service Worker 註冊腳本 -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker 註冊成功:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker 註冊失敗:', error);
                    });
            });
        }
    </script>
</body>
</html>